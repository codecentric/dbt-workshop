unit_tests:
  - name: test_calculate_customer_lifetime_value
    description: "Check my is_valid_email_address logic captures all known edge cases - emails without ., emails without @, and emails from invalid domains."
    model: customers

    given:
      - input: ref('stg_customers')
        rows:
          - {customer_id: 1, first_name: Adam, last_name: A. }
          - {customer_id: 2, first_name: Berta, last_name: B. }
          - {customer_id: 3, first_name: Carla, last_name: C. }
      - input: ref('stg_orders')
        format: csv
        rows: |
          order_id,customer_id,order_date,status
          1,1,2023-01-01,returned
          2,1,2023-01-02,delivered
          3,1,2023-01-03,shipped
          4,1,2023-01-04,created
          5,2,2023-01-05,delivered
          6,2,2023-01-06,shipped
          7,2,2023-01-07,created
      - input: ref('stg_payments')
        format: csv
        rows: |
          payment_id,order_id,payment_method,amount
          1,1,credit_card,10
          2,2,gift_card,20
          3,3,credit_card,30
          4,4,gift_card,40
          5,5,credit_card,50
          6,6,gift_card,60
          7,7,credit_card,70

    expect:
      format: csv
      rows: |
        customer_id,first_name,last_name,most_recent_order,number_of_orders,customer_lifetime_value
        1,Adam,A.,2023-01-04,4,100
        2,Berta,B.,2023-01-07,3,180
        3,Carla,C.,,,
